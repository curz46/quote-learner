import { diffWords } from 'diff'

const ge = `== Pip
"the small bundle of shivers growing afraid of it all and beginning to cry, was Pip"
"I was a common labouring-boy; that my hands were coarse, that my boots were thick"
"I wish Joe had been rather more genteelly brought up, and then I should have been so too."
"'Biddy,' said I, after binding her to secrecy, 'I want to be a gentleman.'"
"Not with pleasure, though I was bound to him by so many times; no; with considerable disturbance, some mortification, and a keen sense of incongruity."
"I did really cry in good earnest when I went to bed, to think that my expectations had done some good to somebody."
== Joe
"He was a mild, good-natured, sweet-tempered, easy-going, foolish, dear fellow - a sort of Hercules in strength, and also in weakness."
"'And bring the poor little child. God bless the poor little child,' I said to your sister, 'there's room for him at the forge!'"
"'I'm wrong in these clothes. I'm wrong out of the forge, the kitchen, or off h'meshes."
"'Pip, old chap, you knowed her when she were a fine figure of a -' and clasped my hand and said no more."
"'Which dear old Pip, old chap,' said Joe, 'you and me was ever friends. And when you're well enough to go out for a ride - what larks!'"
== Miss Havisham
"She was dressed in rich materials...all of white."
"everything within my view which ought to be white, had been white long ago, and had lost its lustre, and was faded and yellow."
"waxwork and skeleton seemed to have dark eyes that moved and looked at me."
"'If she favours you, love her. If she wounds you, love her. If she tears your heart to pieces - and is gets older and stronger, it will tear deeper - love her, love her, love her!'"
"'Estella, Estella, Estella, to be proud and hard to me!'"
"'Oh!' she cried, despairingly. 'What have I done! What have I done!'"
"'When she first came, I meant to save her from misery like mine.'"
== Estella
"She put the mug down on the stones of the yard, and gave me the bread and meat without looking at me, as insolently as if I were a dog in disgrace."
"she slapped my face with such force as she had, when I answered it. 'Now?' Said she. 'You coarse little monster, what do you think of me now?"
"'You must know ... that I have no heart ... I have no softness there, no - sympathy - sentiment"
"'I am what you have made me. Take all the praise, take all the blame; take all the success, take all the failure; in short, take me'"
"'I don't care for what you say at all. I have tried to warn you of this; now, have I not?'"
"'I have been bent and broken, but - I hope - into a better shape.'"
== Magwitch
"A fearful man, all in coarse grey, with a great iron on his lag."
"'You young dog,' said the man, licking his lips, 'what fat cheeks you ha' got.'"
"Master"
"'Yes, Pip, dear boy, I've made a gentleman on you! ... I swore arterwards, sure as ever I spec'lated and got rich, you should get rich.'"
"'I'm you're second father. You're my son - more to me nor any son."
"he raised my hand to his lips."
== Jaggers
"The strange gentleman, with an air of authority not to be disputed, and with a manner expressive of knowing something secret about every one of us that would effectually do for each individual if he chose to disclose it"
"Mr Jagger's own high-backed chair was of deadly horsehair, with rows of brass nails round it, like a coffin"
"he seemed to bully his very sandwich as he ate it)
"He was a thousand times better informed and cleverer than Wemmick, and yet I would a thousand times rather have had Wemmick to dinner."
== Mrs Joe
"she had brought me up 'by hand'"
"She was tall and bony, and almost always wore a coarse apron"
"she pounced on Joe, and, taking him by the two whiskers, knocked his head for a little while against the wall behind him"
"she wanted him to sit down close to her, and wanted me to put her arms round his neck. So I put them round his neck, and she laid her head down in his shoulder quite content and satisfied."
== Herbert Pocket
"His spirit inspired me with great respect."
"Herbert Pocket had a frank and easy way with him that was very taking."
"a natural incapacity to do anything secret and mean."
"he would never be very successful or rich."
"He offered these friendly suggestions in such a lively way, that we both laughed and I scarcely blushed."
"no varnish can hide the grain of the wood; and that the more varnish you put on, the more the grain will express itself."
"the radiant face with which he came home one afternoon"
"his hopes grew stronger and his face brighter"
== Drummle
"he struck me a sulky kind of fellow"
"the first Finch I saw ... was Bentley Drummle: at that time floundering about town in a cab of his own, and doing a great deal of damage to the posts at the street corners."
"I had heard of the death of her husband, from an accident consequent on his ill-treatment of a horse."
== Wemmick
"'my guiding-star always is "Get hold of portable property.'"
"'However, this is not London talk."
== Society/Class
"I wish Joe had been more genteelly brought up, and then I should have been so too."
"I wanted to make Joe less ignorant and common, that he might be worthier of my society and less open to Estella's reproach."
"'Biddy,' said I, after binding her to secrecy, 'I want to be a gentleman.'"
"'I'm wrong in these clothes. I'm wrong out of the forge, the kitchen, or off h'meshes."
"The Finches of the Grove: ... the members should dine expensively once a fortnight, to quarrel among themselves ... and to cause six waiters to get drunk on the stairs."
"We spent as much money as we could ... We were always more or less miserable"
== Ambitions
"Whenever I watched the vessels standing out to sea with their white sails spread, I somehow thought of Miss Havisham and Estella; ... Miss Havisham and Estella and the strange house and the strange life appeared to have something to do with everything that was picturesque."
"She had adopted Estella, she had as good as adopted me, and it could not fail to be her intention to bring us together. She reserved it for me to ... in short, do all the shining deeds of the young Knight of romance, and marry the Princess."
"I thought of the beautiful young Estella, proud and refined, coming towards me, and I thought with absolute abhorrence of the contrast between the jail and her."
"Miss Havisham's intentions towards me, all a mere dream; Estella not designed for me; I only suffered in Satis House as a convenience, a sting for the greedy relations, a model with a mechanical heart to practise on when no other practice was at hand; those were the first smarts I had."
"It would have been cruel in Miss Havisham, horribly cruel, to practise on the susceptibility of a poor boy, and to torture me through all these years with a vain hope and an idle pursuit, if she had reflected on the gravity of what she did. But I think she did not."
== Gender
"she pounced on Joe, and, taking him by the two whiskers, knocked his head for a little while against the wall behind him"
"the bride within the bridal dress had withered like the dress ... the figure upon which it now hung loose, had shrunk to skin and bone ... waxwork and skeleton seemed to have dark eyes that moved and looked at me."
"she wanted him to sit down close to her, and wanted me to put her arms round his neck. So I put them round his neck, and she laid her head down in his shoulder quite content and satisfied."
"The sky was blue, the larks were soaring high over the green corn, I thought that all country-side more beautiful and peaceful by far than I had ever known it to be yet."
"The schoolhouse where Biddy was mistress"
"'It's my wedding day,' cried Biddy, in a burst of happiness, 'and I am married to Joe!'"
== Justice
"He was a mild, good-natured, sweet-tempered, easy-going, foolish, dear fellow - a sort of Hercules in strength, and also in weakness."
"'If she favours you, love her. If she wounds you, love her. If she tears your heart to pieces - and is gets older and stronger, it will tear deeper - love her, love her, love her!'"
"the first Finch I saw ... was Bentley Drummle: at that time floundering about town in a cab of his own, and doing a great deal of damage to the posts at the street corners."
"'Yes, Pip, dear boy, I've made a gentleman on you! ... I swore arterwards, sure as ever I spec'lated and got rich, you should get rich.'"
"The sky was blue, the larks were soaring high over the green corn, I thought that all country-side more beautiful and peaceful by far than I had ever known it to be yet."
"'I have been bent and broken, but - I hope - into a better shape.'"
== Violence
"'what fat cheeks you ha' got ... Darn me if I couldn't eat 'em'"
"she had brought me up 'by hand'"
"she pounced on Joe, and, taking him by the two whiskers, knocked his head for a little while against the wall behind him"
"the first Finch I saw ... was Bentley Drummle: at that time floundering about town in a cab of his own, and doing a great deal of damage to the posts at the street corners."
== Learning
"He offered these friendly suggestions in such a lively way, that we both laughed and I scarcely blushed."
"We spent as much money as we could ... We were always more or less miserable"
"I could not have spoken one word, though it had been to save my life. ... I seemed to be suffocating"`

const inspector = `== The Inspector
"need not be a big man but he creates at once an impression of massiveness, solidity and purposefulness"
"Remember"
"millions and millions and millions of Eva Smiths and John Smiths"
"We are members of one body"
"they will be taught it in fire and blood and anguish"
== Mr Birling
"You ought to like this port, Gerald."
"hard-headed business man"
"hard-headed, practical man of business"
"unsinkable, absolutely unsinkable"
"community and all that nonsense"
"we've several hundred young women there, y'know, and they keep changing."
== Mrs Birling
"a rather cold woman and her husband's social superior."
"Arthur, you're not supposed to say such things"
"We've done a great deal of useful work in helping deserving cases."
"and naturally that was one of the things that prejudiced me against her case."
"I consider I did my duty."
== Sheila
"Quite young?"
"Pretty?"
"I was absolutely furious."
"No, that's no use."
"Fire and blood and anguish."
"No, not yet. It's too soon. I must think."
== Eric
"half shy, half assertive"
"I was in that state when a chap easily turns nasty"
"she was pretty and a good sport"
"What does it matter now whether they give you a knighthood or not?"
"I agree with Sheila. It frightens me too."
== Gerald
"She's had a long, exciting and tiring day"
"I didn't install her there so that I could make love to her."
"I became at once the most important person in her life"
"as I'm rather more - upset - by this business than I probably appear to be - and - well, I'd like to be alone for a little while"
"Everything's all right now, Sheila. What about this ring?"
== Social Class
"You ought to like this port, Gerald."
"There's a fair chance that I might find my way into the next Honours List."
"I was an alderman for years - and Lord Mayor two years ago - and I'm still on the Bench - so I know the Brumley police officers pretty well - and I thought I'd never seen you before."
"I went to the manager at Milwards and I told him that if they didn't get rid of that girl, I'd never go near the place again and I'd persuade mother to close our account with them."
"there'll be a public scandal - unless we're lucky - and who here will suffer from that more than I will?"
== Gender
"Arthur, you're not supposed to say such things"
"Nothing to do with you, Sheila. Run along."
"She's had a long, exciting and tiring day"
"she was pretty and a good sport"
"No, not yet. It's too soon. I must think."
== Change
"Probably a Socialist or some sort of crank"
"You're beginning to pretend now that nothing's really happened at all. And I can't see it like that."
"Fire and blood and anguish."
"What about this ring?"
"No, not yet. It's too soon. I must think."
== Power
"I might find my way into the next Honours List. Just a knighthood, of course."
"Perhaps I ought to warn you that he's an old friend of mine, and that I see him fairly frequently. We play golf together"
"I went to the manager at Milwards and I told him that if they didn't get rid of that girl, I'd never go near the place again and I'd persuade mother to close our account with them."
"I know. Somehow he makes you."
"I suppose it was inevitable. She was young and pretty and warm-hearted - and intensely grateful."
== Responsibility
"If we were all responsible for everything that happened to everybody we'd had anything to do with, it would be very awkward, wouldn't it?"
"So I'm really responsible?"
"I want you to understand that I didn't install her there so that I could make love to her."
"I consider I did my duty."
"We are members of one body. We are responsible for each other."
`

const poetry = `== Ozymandias - Shelley
"Half sunk, a shattered visage lies, whose frown/And wrinkled lip, and sneer of cold command..."
"My name is Ozymandias, king of kings: Look on my works, ye Mighty, and despair!"
"Nothing beside remains."
"The lone and level sands stretch far away."
== London - Blake
"I wander through each chartered street/Near where the charter'd Thames does flow,/And mark in every face I meet/Marks of weakness, marks of woe."
"The mind-forged manacles I hear"
"Runs in blood down palace walls."
== Extract from, The Prelude - Wordsworth
"Small circles glittering idly in the moon"
"sparkling light"
"a huge peak, black and huge"
"Upreared its head"
"But huge and might forms, that do not live/Like living men"
== My Last Duchess - Browning
"Will't you please sit and look at her?"
"The curtain I have drawn for you"
"A heart - how shall I say? - too soon made glad... and her looks went everywhere"
"My gift of a nine-hundred-years-old name/With anybody's gift."
"I gave commands;/Then all smiles stopped together."
== The Charge of the Light Brigade - Tennyson
"Into the valley of Death/Rode the six hundred."
"Theirs but to do and die"
"Cannon to right of them,/Cannon to left of them,/Cannon in front of them"
"All the world wonder'd"
"While horse and hero fell,/They that had fought so well"
== Exposure - Owen
"Our brains ache, in the merciless iced east winds that knive us..."
"mad gusts"
"twitching agonies of men among its brambles"
"Far off, like a dull rumour of some other war."
"But nothing happens."
"Sudden successive flights of bullets streak the silence."
"Pause over half-known faces. All their eyes are ice"
== Storm on the Island - Heaney
"We are prepared: we build our houses squat... Sink... roof"
"leaves and branches/Can raise a tragic chorus in a gale/So you can listen to the thing you fear"
"Exploding comfortably"
"spits like a tame cat/Turned savage."
"Space is a salvo."
== Bayonet Charge - Hughes
"Suddenly he awoke and was running - raw/In raw-seamed hot khaki"
"Bullets smacking the belly out of the air"
"He lugged a rifle numb as a smashed arm"
"In what cold clockwork of the stars and the nations/Was he the hand pointing that second?"
"Threw up a yellow hare that rolled like a flame... its mouth wide/Open silent, its eyes standing out."
"King, honour, human dignity, etcetera/Dropped like luxuries in yelling alarm"
== Remains - Armitage
"probably armed, possibly not."
"Well myself and somebody else and somebody else/are all of the same mind"
"I see every round as it rips through his life"
"sort of inside out,/pain itself, the image of agony."
"and tosses his guts back into his body./Then he's carted off in the back of a lorry."
"End of story, except not really."
"Sleep, and he's probably armed, possibly not./Dream, and he's torn apart by a dozen rounds."
"his bloody life in my bloody hands."
== Poppies - Weir
"Sellotape bandaged around my hand... smoothed down your shirt's upturned collar"
"steeled the softening of my face."
"I resisted the impulse to run my fingers through the gelled blackthorns of your hair."
"All my words, flattened, rolled, turned into felt, slowly melting."
"the world overflowing like a treasure chest... you were away, intoxicated."
"this is where it has led me, skirting the church yard walls"
"I traced the inscriptions on the war memorial, leaned against it liked a wishbone"
"I listened, hoping to hear your playground voice catching on the wind."
== War Photographer - Duffy
"In his darkroom he is finally alone/with spools of suffering set out in ordered rows."
"to fields which don't explode beneath the feet of running children in a nightmare heat."
"He remembers the cries of a man's wife, how he sought approval without words"
"reader's eyeballs prick with tears between the bath and pre-lunch beers."
"he stares impassively at where he earns his living and they do not care."
== Tissue - Dharker
"the back of the Koran, where a hand has written in the names and histories, who was born to whom"
"Maps too. The sun shines through their borderlines, the marks that rivers make, roads"
"Fine slips from grocery shops... might fly our lives like paper kites."
"An architect could use all this... capitals... monoliths... a grand design"
"with living tissue, raise a structure never meant to last... turned into your skin."
== The EmigrÃ©e - Rumens
"but my memory of it is sunlight-clear"
"cannot break/my original view, the bright, filled paperweight."
"sick with tyrants, but I am branded by an impression of sunlight."
"white streets of that city... graceful slopes glow even clearer as time rolls its tanks"
"They accuse me of being dark in their free city/My city hides behind me."
== Checking Out Me History - Agard
"Dem tell me/Dem tell me/Wha dem want to tell me"
"Blind me to me own identity"
"Dem tell me bout 1066 and all dat/dem tell me bout Dick Whittington and he cat"
"...but dem never tell me bout Nanny de maroon... see-far woman/of mountain dream/fire-woman struggle... to freedom river"
== Kamikaze - Garland
"enough fuel for a one-way journey into history"
"looked far down/at the little fishing boats/strung out like bunting/on a green-blue translucent sea"
"dark shoals of fishes/flashing silver as their bellies/swivelled towards the sun"
"bringing their father's boat safe - yes, grandfather's boat - safe"
"And though he came back... they treated him/as though he no longer existed"
"only we children still chattered and laughed/till gradually we too learned/to be silent... that this was no longer the father we loved."
"And sometimes, she said, he must have wondered which had been the better way to die."
`

function parseFile (content) {
  const quotes = []
  let currentGroup
  for (const rawLine of content.split('\n')) {
    const line = rawLine
      .replace('\r', '')
      .replace('\n', '')
    if (line === '') continue
    if (line.startsWith('==')) {
      currentGroup = line.slice(3)
      continue
    }
    quotes.push({
      group: currentGroup,
      text: line.slice(1, -1), // remove '"
      tries: 0
    })
  }
  return quotes
}

function separateQuote (str) {
  const words = str.split(' ')
  const index = Math.floor(words.length / 2)
  return [words.slice(0, index).join(' '), words.slice(index).join(' ')]
}

function createRound (quotes) {
  const quote = quotes[Math.floor(Math.random() * quotes.length)]
  const { text, group } = quote
  const part = Math.random() > 0.5

  const segments = separateQuote(quote.text)
  const prompt = segments[part ? 0 : 1]
  const answer = segments[part ? 1 : 0]

  return { text, group, part, prompt, answer }
}

function createTest (quotes, quoteNum = 20) {
  const test = []
  for (let i = 0; i < quoteNum; i++) {
    const round = createRound(quotes)
    test.push(round)
  }
  return test
}

// const test = [{
//   text: 'twitching agonies of men among its brambles',
//   group: 'some group',
//   part: 0,
//   prompt: 'twitching agonies of men',
//   answer: 'among its brambles"
// }]
// const currentTest = {
//   text: 'twitching agonies of men among its brambles',
//   group: 'some group',
//   part: 0,
//   prompt: 'twitching agonies of men',
//   answer: 'among its brambles',
//   attempt: 'among its brambles"
// }

export default {
  beforeCreate () {
    // get first quote part
  },
  data: function () {
    return {
      mode: 'package', // package|init|test|learn|results
      // test: null,
      round: {
        attempt: '',
        retype: '',
        correct: false
      },
      quotes: [],
      groups: [],
      selectedGroups: [],
      selectedQuotes: [],
      allQuotes: false
    }
  },
  watch: {
    allQuotes (value) {
      if (value) {
        this.selectedGroups = this.groups
        return
      }
      this.selectedGroups = []
    }
  },
  computed: {
    prompt () {
      if (!this.round) return
      return this.round.part
        ? this.round.prompt + '...'
        : '...' + this.round.prompt
    },
    answered () {
      return this.round.attempt !== ''
    },
    action () {
      return this.answered
        ? 'Check'
        : 'Skip'
    },
    words () {
      return this.mode === 'test'
        ? this.round.answer.split(' ').length
        : 0
    },
    hasRetyped () {
      return this.round.correct || this.round.retype === this.round.answer
    }
  },
  methods: {
    select (name) {
      const quotePackages = {
        macbeth: null,
        ge,
        poetry,
        inspector
      }
      const quotePackage = quotePackages[name]
      if (!quotePackage) return

      this.quotes = parseFile(quotePackage)
      this.groups = this.quotes.reduce((arr, { group }) => {
        if (!arr.includes(group)) arr.push(group)
        return arr
      }, [])
      this.selectedGroups = []

      this.test = createTest(this.quotes)
      this.round = Object.assign({}, this.test[0], {
        attempt: '',
        retype: '',
        correct: false
      })
      this.test.splice(0, 1)
      this.mode = 'init'
    },
    getSelectedQuotes () {
      return this.quotes
        .filter(quote => this.selectedGroups.includes(quote.group))
    },
    progressTest () {
      this.round = Object.assign({}, this.test[0], {
        attempt: '',
        retype: '',
        correct: false
      })
      this.test.splice(0, 1)
    },
    next () {
      if (this.mode === 'learn') {
        if (!this.hasRetyped) return
        this.mode = 'test'
      }
      if (this.mode === 'init') {
        this.test = createTest(this.getSelectedQuotes())
        this.mode = 'test'
      }
      this.progressTest()
    },
    check () {
      // test if correct
      console.log(this.round.answer, this.round.attempt)
      const tokens = diffWords(
        this.round.answer,
        this.round.attempt,
        { ignoreCase: true }
      )
      const onlyPunctuation = tokens
        .filter(part => (part.added || part.removed) &&
          /[A-z0-9]+/.test(part.value))
        .length === 0
      const correct = (tokens
        .filter(part => part.added || part.removed)
        .length === 0)

      // update state
      this.mode = 'learn'
      this.round.correct = correct || onlyPunctuation
      this.round.tokens = tokens
    }
  }
}
